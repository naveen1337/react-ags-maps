(window.webpackJsonp=window.webpackJsonp||[]).push([[166],{DSKt:function(e,t,r){"use strict";r.r(t);var i=r("eijD"),n=r("hisu"),a=r("yBJb"),s=r("4Mpa"),l=r("CHlC"),o=r("kMo5"),c=r("P+uj"),u=r("NthX"),h=r.n(u),f=r("dQW7"),y=r("4VMI"),d=r("Mp7X"),v=r("UfAV"),p=r("0fJP"),_=r("TM+E"),b=r("7im+"),g=r("IH5m"),m=r("xAIp"),w=(r("wckI"),r("J4Pc")),S=r("iaHD"),k=r("nk/L"),O=r("+MdM"),T=r("mK0O"),x=r("DGz/"),j=r("5iHx"),C=r("Akvs"),I=(r("a1c8"),r("iwTS"),r("B2Uc"),r("cY28"),r("IxxH"),r("0fR5")),R=(r("H8zE"),r("hLiK")),P=function(){function e(t,r){Object(n.a)(this,e),this._width=0,this._height=0,this._free=[],this._width=t,this._height=r,this._free.push(new R.a(0,0,t,r))}return Object(a.a)(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"allocate",value:function(e,t){if(e>this._width||t>this._height)return new R.a;for(var r=null,i=-1,n=0;n<this._free.length;++n){var a=this._free[n];e<=a.width&&t<=a.height&&(null===r||a.y<=r.y&&a.x<=r.x)&&(r=a,i=n)}return null===r?new R.a:(this._free.splice(i,1),r.width<r.height?(r.width>e&&this._free.push(new R.a(r.x+e,r.y,r.width-e,t)),r.height>t&&this._free.push(new R.a(r.x,r.y+t,r.width,r.height-t))):(r.width>e&&this._free.push(new R.a(r.x+e,r.y,r.width-e,r.height)),r.height>t&&this._free.push(new R.a(r.x,r.y+t,e,r.height-t))),new R.a(r.x,r.y,e,t))}},{key:"release",value:function(e){for(var t=0;t<this._free.length;++t){var r=this._free[t];if(r.y===e.y&&r.height===e.height&&r.x+r.width===e.x)r.width+=e.width;else if(r.x===e.x&&r.width===e.width&&r.y+r.height===e.y)r.height+=e.height;else if(e.y===r.y&&e.height===r.height&&e.x+e.width===r.x)r.x=e.x,r.width+=e.width;else{if(e.x!==r.x||e.width!==r.width||e.y+e.height!==r.y)continue;r.y=e.y,r.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}]),e}();function M(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return D(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return D(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var L=function(){function e(t,r,i){Object(n.a)(this,e),this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=r,this._glyphSource=i,this._binPack=new P(t-4,r-4),this._glyphData.push(new Uint8Array(t*r)),this._dirties.push(!0),this._textures.push(void 0)}return Object(a.a)(e,[{key:"getGlyphItems",value:function(e,t){var r,i=this,n=[],a=this._glyphSource,s=new Set,l=M(t);try{for(l.s();!(r=l.n()).done;){var o=r.value,c=Math.floor(o*(1/256));s.add(c)}}catch(h){l.e(h)}finally{l.f()}var u=[];return s.forEach((function(t){if(t<=256){var r=e+t;if(i._rangePromises.has(r))u.push(i._rangePromises.get(r));else{var n=a.getRange(e,t).then((function(){i._rangePromises.delete(r)}),(function(){i._rangePromises.delete(r)}));i._rangePromises.set(r,n),u.push(n)}}})),Promise.all(u).then((function(){var r=i._glyphIndex[e];r||(r={},i._glyphIndex[e]=r);var s,l=M(t);try{for(l.s();!(s=l.n()).done;){var o=s.value,c=r[o];if(c)n[o]={sdf:!0,rect:c.rect,metrics:c.metrics,page:c.page,code:o};else{var u=a.getGlyph(e,o);if(u&&u.metrics){var f=u.metrics,y=void 0;if(0===f.width)y=new R.a(0,0,0,0);else{var d=f.width+6,v=f.height+6,p=d%4?4-d%4:4,_=v%4?4-v%4:4;1===p&&(p=5),1===_&&(_=5),(y=i._binPack.allocate(d+p,v+_)).isEmpty&&(i._dirties[i._currentPage]||(i._glyphData[i._currentPage]=null),i._currentPage=i._glyphData.length,i._glyphData.push(new Uint8Array(i.width*i.height)),i._dirties.push(!0),i._textures.push(void 0),i._binPack=new P(i.width-4,i.height-4),y=i._binPack.allocate(d+p,v+_));var b=i._glyphData[i._currentPage],g=u.bitmap,m=void 0,w=void 0;if(g)for(var S=0;S<v;S++){m=d*S,w=i.width*(y.y+S+1)+y.x;for(var k=0;k<d;k++)b[w+k+1]=g[m+k]}}r[o]={rect:y,metrics:f,tileIDs:null,page:i._currentPage},n[o]={sdf:!0,rect:y,metrics:f,page:i._currentPage,code:o},i._dirties[i._currentPage]=!0}}}}catch(h){l.e(h)}finally{l.f()}return n}))}},{key:"removeGlyphs",value:function(e){for(var t in this._glyphIndex){var r=this._glyphIndex[t];if(r){var i=void 0;for(var n in r)if((i=r[n]).tileIDs.delete(e),0===i.tileIDs.size){for(var a=this._glyphData[i.page],s=i.rect,l=void 0,o=void 0,c=0;c<s.height;c++)for(l=this.width*(s.y+c)+s.x,o=0;o<s.width;o++)a[l+o]=0;delete r[n],this._dirties[i.page]=!0}}}}},{key:"bind",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this._textures[r]||(this._textures[r]=new I.a(e,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));var n=this._textures[r];n.setSamplingMode(t),this._dirties[r]&&n.setData(this._glyphData[r]),e.bindTexture(n,i),this._dirties[r]=!1}},{key:"dispose",value:function(){this._binPack=null;var e,t=M(this._textures);try{for(t.s();!(e=t.n()).done;){var r=e.value;r&&r.dispose()}}catch(i){t.e(i)}finally{t.f()}this._textures.length=0}}]),e}(),A=r("4i+k"),U=function(){function e(t){if(Object(n.a)(this,e),this._metrics=[],this._bitmaps=[],t)for(;t.next();)switch(t.tag()){case 1:for(var r=t.getMessage();r.next();)switch(r.tag()){case 3:for(var i=r.getMessage(),a=void 0,s=void 0,l=void 0,o=void 0,c=void 0,u=void 0,h=void 0;i.next();)switch(i.tag()){case 1:a=i.getUInt32();break;case 2:s=i.getBytes();break;case 3:l=i.getUInt32();break;case 4:o=i.getUInt32();break;case 5:c=i.getSInt32();break;case 6:u=i.getSInt32();break;case 7:h=i.getUInt32();break;default:i.skip()}i.release(),a&&(this._metrics[a]={width:l,height:o,left:c,top:u,advance:h},this._bitmaps[a]=s);break;default:r.skip()}r.release();break;default:t.skip()}}return Object(a.a)(e,[{key:"getMetrics",value:function(e){return this._metrics[e]}},{key:"getBitmap",value:function(e){return this._bitmaps[e]}}]),e}(),z=function(){function e(){Object(n.a)(this,e),this._ranges=[]}return Object(a.a)(e,[{key:"getRange",value:function(e){return this._ranges[e]}},{key:"addRange",value:function(e,t){this._ranges[e]=t}}]),e}(),q=function(){function e(t){Object(n.a)(this,e),this._glyphInfo={},this._baseURL=t}return Object(a.a)(e,[{key:"getRange",value:function(e,t){var r=this._getFontStack(e);if(r.getRange(t))return Promise.resolve();var i=256*t,n=i+255,a=this._baseURL.replace("{fontstack}",e).replace("{range}",i+"-"+n);return Object(x.default)(a,{responseType:"array-buffer"}).then((function(e){r.addRange(t,new U(new A.a(new Uint8Array(e.data),new DataView(e.data))))})).catch((function(){r.addRange(t,new U)}))}},{key:"getGlyph",value:function(e,t){var r=this._getFontStack(e);if(r){var i=Math.floor(t/256);if(!(i>256)){var n=r.getRange(i);return n?{metrics:n.getMetrics(t),bitmap:n.getBitmap(t)}:void 0}}}},{key:"_getFontStack",value:function(e){var t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new z),t}}]),e}(),H=r("aNYv"),F=r("jCQE");function V(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return E(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return E(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function E(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var B=function(){function e(t,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;Object(n.a)(this,e),this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(t<=0||r<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=r,i>0&&(this._maxItemSize=i),this._binPack=new P(t-4,r-4)}return Object(a.a)(e,[{key:"dispose",value:function(){this._binPack=null,this._mosaicRects={};var e,t=V(this._textures);try{for(t.s();!(e=t.n()).done;){var r=e.value;r&&r.dispose()}}catch(i){t.e(i)}finally{t.f()}this._textures.length=0}},{key:"getWidth",value:function(e){return e>=this._size.length?-1:this._size[e][0]}},{key:"getHeight",value:function(e){return e>=this._size.length?-1:this._size[e][1]}},{key:"getPageSize",value:function(e){return e>=this._size.length?null:this._size[e]}},{key:"setSpriteSource",value:function(e){if(this.dispose(),this.pixelRatio=e.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new P(this._pageWidth-4,this._pageHeight-4);var t=Math.floor(this._pageWidth),r=Math.floor(this._pageHeight),i=new Uint32Array(t*r);this._mosaicsData[0]=i,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=e}},{key:"getSpriteItem",value:function(e){var t,r,i,n,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=this._mosaicRects[e];if(s)return s;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;if(e&&e.startsWith("dasharray-")?(t=this._rasterizeDash(e),i=(r=Object(H.a)(t,2))[0],n=r[1],a=!0):i=this._sprites.getSpriteInfo(e),!i||!i.width||!i.height||i.width<0||i.height<0)return null;var l=i.width,o=i.height,c=this._allocateImage(l,o),u=Object(H.a)(c,3),h=u[0],f=u[1],y=u[2];return h.width<=0?null:(this._copy(h,i,f,y,a,n),s={rect:h,width:l,height:o,sdf:i.sdf,simplePattern:!1,pixelRatio:i.pixelRatio,page:f},this._mosaicRects[e]=s,s)}},{key:"getSpriteItems",value:function(e){var t,r={},i=V(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;r[n.name]=this.getSpriteItem(n.name,n.repeat)}}catch(a){i.e(a)}finally{i.f()}return r}},{key:"getMosaicItemPosition",value:function(e,t){var r=this.getSpriteItem(e,t),i=r&&r.rect;if(!i)return null;i.width=r.width,i.height=r.height;var n=r.width,a=r.height;return{tl:[i.x+2,i.y+2],br:[i.x+2+n,i.y+2+a],page:r.page}}},{key:"bind",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this._textures[r]||(this._textures[r]=new I.a(e,{pixelFormat:6408,dataType:5121,wrapMode:33071,width:this._size[r][0],height:this._size[r][1]},new Uint8Array(this._mosaicsData[r].buffer)));var n=this._textures[r];n.setSamplingMode(t),this._dirties[r]&&n.setData(new Uint8Array(this._mosaicsData[r].buffer)),e.bindTexture(n,i),this._dirties[r]=!1}},{key:"_copy",value:function(t,r,i,n,a,s){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(i>=this._mosaicsData.length)){var l=new Uint32Array(s?s.buffer:this._sprites.image.buffer),o=this._mosaicsData[i];o&&l||console.error("Source or target images are uninitialized!");var c=s?r.width:this._sprites.width;e._copyBits(l,c,r.x,r.y,o,n[0],t.x+2,t.y+2,r.width,r.height,a),this._dirties[i]=!0}}},{key:"_allocateImage",value:function(e,t){e+=2,t+=2;var r=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<r){var i=new R.a(0,0,e,t);return this._mosaicsData.push(new Uint32Array(e*t)),this._dirties.push(!0),this._size.push([e,t]),this._textures.push(void 0),[i,this._mosaicsData.length-1,[e,t]]}var n=e%4?4-e%4:4,a=t%4?4-t%4:4;1===n&&(n=5),1===a&&(a=5);var s=this._binPack.allocate(e+n,t+a);return s.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new P(this._pageWidth-4,this._pageHeight-4),this._allocateImage(e,t)):[s,this._currentPage,[this._pageWidth,this._pageHeight]]}},{key:"_rasterizeDash",value:function(e){var t=e.match(/\[(.*?)\]/);if(!t)return null;var r=t[1].split(",").map(Number),i=e.slice(e.lastIndexOf("-")+1),n=F.c.rasterizeDash(r,i),a=Object(H.a)(n,3),s=a[0];return[{x:0,y:0,width:a[1],height:a[2],sdf:!0,pixelRatio:1},new Uint8Array(s.buffer)]}}],[{key:"_copyBits",value:function(e,t,r,i,n,a,s,l,o,c,u){var h=i*t+r,f=l*a+s;if(u){f-=a;for(var y=-1;y<=c;h=((++y+c)%c+i)*t+r,f+=a)for(var d=-1;d<=o;d++)n[f+d]=e[h+(d+o)%o]}else for(var v=0;v<c;v++){for(var p=0;p<o;p++)n[f+p]=e[h+p];h+=t,f+=a}}}]),e}(),Q=r("eyU2");function J(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return N(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return N(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function N(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function W(e,t,r,i,n,a){e.fillStyle=t,e.fillRect(r,i,n,a)}function G(e,t,r,i,n,a){e.strokeStyle=t,e.strokeRect(r,i,n,a)}function K(e,t){e.strokeStyle="black";for(var r=t.cellSize,i=t.rows,n=t.columns,a=0;a<i;a++)for(var s=t.cells[a],l=a*r,o=(a+1)*r,c=0;c<n;c++){var u=s[c],h=c*r,f=(c+1)*r;e.strokeRect(h,l,f-h,o-l),e.fillText("cells:".concat(u.length),h+4,l+12)}}function $(e,t){for(var r=window.COLLISION_XRAY,i=0;i<t.length;++i){var n=!t[i].unique.show;if(r||!n){var a,s=J(t[i].colliders);try{for(s.s();!(a=s.n()).done;){var l=a.value;if(l.enabled){var o=!t[i].unique.parts[l.partIndex].show;if(r||!o){var c=l.xScreen,u=l.yScreen,h=l.dxScreen,f=l.dyScreen;e.globalAlpha=n||o?.2:1,W(e,"green",c-1,u-1,3,3),G(e,"red",c+h,u+f,l.width,l.height),W(e,"blue",c+h-1,u+f-1,3,3),e.globalAlpha=1}}}}catch(y){s.e(y)}finally{s.f()}}}}var Y=r("60x+");function X(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Z(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?X(Object(r),!0).forEach((function(t){Object(T.a)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):X(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var ee=new j.a(10),te=new Map,re=function(){function e(t,r,i){Object(n.a)(this,e),this._vectorTileLayer=t,this._styleRepository=r,this.devicePixelRatio=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null}var t,r,s,l,o,c;return Object(a.a)(e,[{key:"destroy",value:function(){this._connection&&(this._connection.close(),this._connection=null),this._styleRepository=null,this._vectorTileLayer=null,this._spriteMosaic&&(this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic=null)}},{key:"spriteMosaic",get:function(){var e=this;return this._spriteSourcePromise.then((function(){return e._spriteMosaic}))}},{key:"glyphMosaic",get:function(){return this._glyphMosaic}},{key:"start",value:(c=Object(i.a)(h.a.mark((function e(t){var r,i,n,a,s,l,o=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(a in r=this._vectorTileLayer,i=r.sourceNameToSource,n=[],i)n.push(this._fetchTileMap(i[a],t));return this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,t),this._spriteSourcePromise.then((function(e){o._spriteMosaic=new B(1024,1024,250),o._spriteMosaic.setSpriteSource(e)})),s=this._styleRepository,l=new q(s.glyphs),e.abrupt("return",(this._glyphMosaic=new L(1024,1024,l),this._broadcastPromise=Object(C.b)("WorkerTileHandler",{client:this,schedule:t.schedule,signal:t.signal}).then((function(e){return o._connection=e,Promise.all(o._connection.broadcast("setStyle",{style:r.currentStyleInfo.style,vectorTileLayerMaxBuffers:Object(w.a)("vectortilelayer-max-buffers")},t))})),Promise.all(n)));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"updateStyle",value:(o=Object(i.a)(h.a.mark((function e(t){var r=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._broadcastPromise;case 2:return this._broadcastPromise=new Promise((function(e,i){Promise.all(r._connection.broadcast("updateStyle",t)).then(e,i)})),e.abrupt("return",this._broadcastPromise);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"setStyle",value:(l=Object(i.a)(h.a.mark((function e(t,r){var i,n,a,s,l=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._broadcastPromise;case 2:for(a in this._styleRepository=t,i=this._vectorTileLayer.sourceNameToSource,n=[],i)n.push(this._fetchTileMap(i[a],null));return this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,null),this._spriteSourcePromise.then((function(e){l._spriteMosaic=new B(1024,1024,250),l._spriteMosaic.setSpriteSource(e)})),s=new q(t.glyphs),e.abrupt("return",(this._glyphMosaic=new L(1024,1024,s),this._broadcastPromise=new Promise((function(e,t){Promise.all(l._connection.broadcast("setStyle",{style:r,vectorTileLayerMaxBuffers:Object(w.a)("vectortilelayer-max-buffers")})).then(e,t)})),n.push(this._broadcastPromise),Promise.all(n)));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"fetchTileData",value:function(e,t){var r=this;return this._getRefKeys(e,t).then((function(e){var i=r._vectorTileLayer.sourceNameToSource,n=[];for(var a in i)n.push(a);return r._getSourcesData(n,e,t)}))}},{key:"parseTileData",value:function(e,t){var r=this,i=e&&e.data;if(!i)return Promise.resolve(null);var n=i.sourceName2DataAndRefKey,a=i.transferList;return 0===Object.keys(n).length?Promise.resolve(null):this._broadcastPromise.then((function(){return r._connection.getAvailableClient().then((function(r){return r.invoke("createTileAndParse",{key:e.key.id,sourceName2DataAndRefKey:n,styleLayerUIDs:e.styleLayerUIDs},Z(Z({},t),{},{transferList:a})).then((function(e){return{tileData:e}}))}))}))}},{key:"getSprites",value:(s=Object(i.a)(h.a.mark((function e(t){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._spriteSourcePromise;case 2:return e.abrupt("return",this._spriteMosaic.getSpriteItems(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"getGlyphs",value:function(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)}},{key:"perfReport",value:function(e){!function(e,t,r){if(window.PERFORMANCE_RECORDING_STORAGE){var i=window.PERFORMANCE_RECORDING_STORAGE;i.perf=i.perf||{};var n=i.perf;n[e]=n[e]||{start:null,time:0,min:void 0,max:void 0,samples:[],unit:r},n[e].time+=t,n[e].samples.push(t),(null==n[e].min||t<n[e].min)&&(n[e].min=t),(null==n[e].max||t>n[e].max)&&(n[e].max=t)}}(e.key,e.milliseconds,"ms")}},{key:"_getTilePayload",value:(r=Object(i.a)(h.a.mark((function e(t,r,i){var n,a;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Y.a.pool.acquire(t.id),a=this._vectorTileLayer.sourceNameToSource[r].getSourceTileUrl(n.level,n.row,n.col),Y.a.pool.release(n),e.prev=2,e.next=5,this.request(a,i);case 5:return e.t0=e.sent,e.t1=r,e.abrupt("return",{protobuff:e.t0,sourceName:e.t1});case 10:if(e.prev=10,e.t2=e.catch(2),!Object(g.m)(e.t2)){e.next=14;break}throw e.t2;case 14:return e.abrupt("return",{protobuff:null,sourceName:r});case 15:case"end":return e.stop()}}),e,this,[[2,10]])}))),function(e,t,i){return r.apply(this,arguments)})},{key:"request",value:function(e,t){return Object(x.default)(e,Z({responseType:"array-buffer"},t)).then((function(e){return e.data}))}},{key:"_fetchTileMap",value:(t=Object(i.a)(h.a.mark((function e(t,r){var i,n,a;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.capabilities.operations.supportsTileMap||!t.tileIndex){e.next=2;break}return e.abrupt("return",Promise.resolve());case 2:if(t.tileMapURL){e.next=4;break}return e.abrupt("return");case 4:if(!(i=ee.get(t.tileMapURL))){e.next=7;break}return e.abrupt("return",void(t.tileIndex=i));case 7:if(!te.has(t.tileMapURL)){e.next=20;break}return e.prev=8,e.next=11,te.get(t.tileMapURL);case 11:n=e.sent,t.tileIndex=new Q.a(n.data),e.next=19;break;case 15:if(e.prev=15,e.t0=e.catch(8),!Object(g.m)(e.t0)){e.next=19;break}throw e.t0;case 19:return e.abrupt("return");case 20:return a=Object(x.default)(t.tileMapURL,r),te.set(t.tileMapURL,a),e.prev=22,e.next=25,a;case 25:n=e.sent,te.delete(t.tileMapURL),ee.put(t.tileMapURL,t.tileIndex),t.tileIndex=new Q.a(n.data),e.next=35;break;case 31:if(e.prev=31,e.t1=e.catch(22),te.delete(t.tileMapURL),!Object(g.m)(e.t1)){e.next=35;break}throw e.t1;case 35:case"end":return e.stop()}}),e,null,[[8,15],[22,31]])}))),function(e,r){return t.apply(this,arguments)})},{key:"_getRefKeys",value:function(e,t){var r=this._vectorTileLayer.sourceNameToSource,i=new Array;for(var n in r){var a=r[n].getRefKey(e,t);i.push(a)}return Object(g.j)(i)}},{key:"_getSourcesData",value:function(e,t,r){for(var i=[],n=0;n<t.length;n++)if(null==t[n].value||null==e[n])i.push(null);else{var a=this._getTilePayload(t[n].value,e[n],r);i.push(a)}return Object(g.j)(i).then((function(e){for(var r={},i=[],n=0;n<e.length;n++)if(e[n].value&&e[n].value&&e[n].value.protobuff&&e[n].value.protobuff.byteLength>0){var a=t[n].value.id;r[e[n].value.sourceName]={refKey:a,protobuff:e[n].value.protobuff},i.push(e[n].value.protobuff)}return{sourceName2DataAndRefKey:r,transferList:i}}))}}]),e}(),ie=r("tajk"),ne=r("EGWc");function ae(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return se(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return se(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function se(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var le=function(e,t){return e+1/(1<<2*t)},oe=function(){function e(t,r){Object(n.a)(this,e),this._tiles=new Map,this._tileCache=new ie.a(40,(function(e){return e.dispose()})),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=r}return Object(a.a)(e,[{key:"destroy",value:function(){var e,t=ae(this._tiles);try{for(t.s();!(e=t.n()).done;){var r=Object(H.a)(e.value,2);r[0];r[1].dispose()}}catch(i){t.e(i)}finally{t.f()}this._tiles=null,this._tileCache.clear(),this._tileCache=null}},{key:"update",value:function(e){this._updateCacheSize(e);var t,r=this.tileInfoView,i=r.getTileCoverage(e.state,0,"smallest"),n=i.spans,a=i.lodInfo,s=a.level,l=new Set,o=new Set,c=ae(n);try{for(c.s();!(t=c.n()).done;)for(var u=t.value,h=u.row,f=u.colFrom,y=u.colTo,d=f;d<=y;d++){var v=Y.a.getId(s,h,a.normalizeCol(d),a.getWorldForColumn(d)),p=this._getOrAcquireTile(v);l.add(v),p.processed()?this._addToContainer(p):o.add(new Y.a(v))}}catch(L){c.e(L)}finally{c.f()}var _,b=ae(this._tiles);try{for(b.s();!(_=b.n()).done;){var g=Object(H.a)(_.value,2),m=g[0];g[1].isCoverage=l.has(m)}}catch(L){b.e(L)}finally{b.f()}var w,S=ae(o);try{for(S.s();!(w=S.n()).done;){var k=w.value;this._findPlaceholdersForMissingTiles(k,l)}}catch(L){S.e(L)}finally{S.f()}var O,T=!1,x=ae(this._tiles);try{for(x.s();!(O=x.n()).done;){var j=Object(H.a)(O.value,2),C=j[0],I=j[1];I.neededForCoverage=l.has(C),I.neededForCoverage||I.isHoldingForFade&&r.intersects(i,I.key)&&l.add(C),I.isFading&&(T=!0)}}catch(L){x.e(L)}finally{x.f()}var R,P=ae(this._tiles);try{for(P.s();!(R=P.n()).done;){var M=Object(H.a)(R.value,2),D=M[0];M[1];l.has(D)||this._releaseTile(D)}}catch(L){P.e(L)}finally{P.f()}return ne.a.pool.release(i),!T}},{key:"clear",value:function(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}},{key:"clearCache",value:function(){this._tileCache.clear()}},{key:"_findPlaceholdersForMissingTiles",value:function(e,t){var r,i=[],n=ae(this._tiles);try{for(n.s();!(r=n.n()).done;){var a=Object(H.a)(r.value,2),s=(a[0],a[1]);this._addPlaceholderChild(i,s,e,t)}}catch(o){n.e(o)}finally{n.f()}var l=i.reduce(le,0);Math.abs(1-l)<1e-6||this._addPlaceholderParent(e.id,t)}},{key:"_addPlaceholderChild",value:function(e,t,r,i){t.key.level<=r.level||!t.hasData()||function(e,t){var r=t.level-e.level;return e.row===t.row>>r&&e.col===t.col>>r&&e.world===t.world}(r,t.key)&&(this._addToContainer(t),i.add(t.id),e.push(t.key.level-r.level))}},{key:"_addPlaceholderParent",value:function(e,t){for(var r=e;;){if(!(r=ce(r))||t.has(r))return;var i=this._getTile(r);if(i&&i.hasData())return this._addToContainer(i),void t.add(i.id)}}},{key:"_getOrAcquireTile",value:function(e){var t=this._tiles.get(e);return t||((t=this._tileCache.pop(e))||(t=this.acquireTile(new Y.a(e))),this._tiles.set(e,t),t)}},{key:"_getTile",value:function(e){var t=this._tiles.get(e);return t||((t=this._tileCache.pop(e))&&this._tiles.set(e,t),t)}},{key:"_releaseTile",value:function(e){var t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}},{key:"_addToContainer",value:function(e){var t,r=[],i=this._container;if(!i.contains(e)){var n,a=this._visibleTiles,s=ae(a);try{for(s.s();!(n=s.n()).done;){var l=Object(H.a)(n.value,2),o=(l[0],l[1]);this._canConnectDirectly(e,o)&&r.push(o),Object(b.h)(t)&&this._canConnectDirectly(o,e)&&(t=o)}}catch(v){s.e(v)}finally{s.f()}if(Object(b.i)(t)){var c,u=ae(r);try{for(u.s();!(c=u.n()).done;){var h=c.value;t.childrenTiles.delete(h),e.childrenTiles.add(h),h.parentTile=e}}catch(v){u.e(v)}finally{u.f()}t.childrenTiles.add(e),e.parentTile=t}else{var f,y=ae(r);try{for(y.s();!(f=y.n()).done;){var d=f.value;e.childrenTiles.add(d),d.parentTile=e}}catch(v){y.e(v)}finally{y.f()}}a.set(e.id,e),i.addChild(e)}}},{key:"_removeFromContainer",value:function(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),Object(b.i)(e.parentTile)){e.parentTile.childrenTiles.delete(e);var t,r=ae(e.childrenTiles);try{for(r.s();!(t=r.n()).done;){var i=t.value;Object(b.i)(e.parentTile)&&e.parentTile.childrenTiles.add(i)}}catch(s){r.e(s)}finally{r.f()}}var n,a=ae(e.childrenTiles);try{for(a.s();!(n=a.n()).done;){n.value.parentTile=e.parentTile}}catch(s){a.e(s)}finally{a.f()}e.parentTile=null,e.childrenTiles.clear()}},{key:"_canConnectDirectly",value:function(e,t){for(var r=e.key,i=t.key,n=i.level,a=i.row,s=i.col,l=i.world,o=this._visibleTiles;n>0;){if(n--,a>>=1,s>>=1,r.level===n&&r.row===a&&r.col===s&&r.world===l)return!0;if(o.has("".concat(n,"/").concat(a,"/").concat(s,"/").concat(l)))return!1}return!1}},{key:"_updateCacheSize",value:function(e){var t=e.state.size;if(t[0]!==this._viewSize[0]||t[1]!==this._viewSize[1]){var r=Math.ceil(t[0]/512)+1,i=Math.ceil(t[1]/512)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*r*i}}}]),e}();function ce(e){var t=e.split("/"),r=Object(H.a)(t,4),i=r[0],n=r[1],a=r[2],s=r[3],l=parseInt(i,10);return 0===l?null:"".concat(l-1,"/").concat(parseInt(n,10)>>1,"/").concat(parseInt(a,10)>>1,"/").concat(parseInt(s,10))}var ue=r("8igk"),he=r("6CzD"),fe=r("v3KF"),ye=r("bQwG"),de=r("6N4x"),ve=r("Tkaf"),pe=r("Y8sq");function _e(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return be(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return be(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function be(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function ge(e,t,r,i,n,a){var s,l=i.iconRotationAlignment,o=i.textRotationAlignment,c=i.iconTranslate,u=i.iconTranslateAnchor,h=i.textTranslate,f=i.textTranslateAnchor,y=0,d=_e(e.colliders);try{for(d.s();!(s=d.n()).done;){var v=s.value,p=0===v.partIndex?c:h,_=Object(H.a)(p,2),b=_[0],g=_[1],m=0===v.partIndex?u:f,w=v.minLod<=a&&a<=v.maxLod;y+=w?0:1,v.enabled=w,v.xScreen=v.xTile*n[0]+v.yTile*n[3]+n[6],v.yScreen=v.xTile*n[1]+v.yTile*n[4]+n[7],0===m?(v.xScreen+=r*b-t*g,v.yScreen+=t*b+r*g):(v.xScreen+=b,v.yScreen+=g),1===(0===v.partIndex?l:o)?(v.dxScreen=v.dxPixels,v.dyScreen=v.dyPixels):(v.dxScreen=r*(v.dxPixels+v.width/2)-t*(v.dyPixels+v.height/2)-v.width/2,v.dyScreen=t*(v.dxPixels+v.width/2)+r*(v.dyPixels+v.height/2)-v.height/2)}}catch(S){d.e(S)}finally{d.f()}e.colliders.length>0&&y===e.colliders.length&&(e.unique.show=!1)}var me=function(){function e(t,r,i,a,s,l){Object(n.a)(this,e),this._symbols=t,this._styleRepository=a,this._zoom=s,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new pe.a(r,i,ye.a),this._si=Math.sin(Math.PI*l/180),this._co=Math.cos(Math.PI*l/180);var o,c=_e(t);try{for(c.s();!(o=c.n()).done;){var u,h=_e(o.value.symbols);try{for(h.s();!(u=h.n()).done;){var f=u.value;this._allNeededMatrices.has(f.tile)||this._allNeededMatrices.set(f.tile,Object(ve.a)(f.tile.transforms.tileUnitsToPixels))}}catch(y){h.e(y)}finally{h.f()}}}catch(y){c.e(y)}finally{c.f()}}return Object(a.a)(e,[{key:"work",value:function(e){var t=this._gridIndex;function r(e){for(var r=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,n=r+e.width,a=i+e.height,s=t.getCellSpan(r,i,n,a),l=Object(H.a)(s,4),o=l[0],c=l[1],u=l[2],h=l[3],f=c;f<=h;f++)for(var y=o;y<=u;y++){var d,v=_e(t.cells[f][y]);try{for(v.s();!(d=v.n()).done;){var p=d.value,_=p.xScreen+p.dxScreen,b=p.yScreen+p.dyScreen,g=_+p.width,m=b+p.height;if(!(n<_||r>g||a<b||i>m))return!0}}catch(w){v.e(w)}finally{v.f()}}return!1}for(var i=performance.now();this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0)for(var n=this._symbols[this._currentLayerCursor],a=this._getProperties(n.styleLayerUID);this._currentSymbolCursor<n.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-i>e)return!1;var s=n.symbols[this._currentSymbolCursor];if(s.unique.show){ge(s,this._si,this._co,a,this._allNeededMatrices.get(s.tile),this._zoom);var l=s.unique;if(l.show){var o,c=a.iconAllowOverlap,u=a.iconIgnorePlacement,h=a.textAllowOverlap,f=a.textIgnorePlacement,y=_e(s.colliders);try{for(y.s();!(o=y.n()).done;){var d=o.value;if(d.enabled){var v=l.parts[d.partIndex];v.show&&!(d.partIndex?h:c)&&r(d)&&(d.hard?l.show=!1:v.show=!1)}}}catch(P){y.e(P)}finally{y.f()}if(l.show){var p,_=_e(s.colliders);try{for(_.s();!(p=_.n()).done;){var b=p.value;if(b.enabled&&(!(b.partIndex?f:u)&&l.parts[b.partIndex].show))for(var g=b.xScreen+b.dxScreen,m=b.yScreen+b.dyScreen,w=g+b.width,S=m+b.height,k=this._gridIndex.getCellSpan(g,m,w,S),O=Object(H.a)(k,4),T=O[0],x=O[1],j=O[2],C=O[3],I=x;I<=C;I++)for(var R=T;R<=j;R++)this._gridIndex.cells[I][R].push(b)}}catch(P){_.e(P)}finally{_.f()}}}}}return!0}},{key:"_getProperties",value:function(e){var t=this._styleProps.get(e);if(t)return t;var r=this._zoom,i=this._styleRepository.getStyleLayerByUID(e),n=0!==i.getLayoutValue("symbol-placement",r),a=i.getLayoutValue("icon-rotation-alignment",r);2===a&&(a=n?0:1);var s=i.getLayoutValue("text-rotation-alignment",r);2===s&&(s=n?0:1);var l=i.getPaintValue("icon-translate",r),o=i.getPaintValue("icon-translate-anchor",r),c=i.getPaintValue("text-translate",r),u=i.getPaintValue("text-translate-anchor",r),h={iconAllowOverlap:i.getLayoutValue("icon-allow-overlap",r),iconIgnorePlacement:i.getLayoutValue("icon-ignore-placement",r),textAllowOverlap:i.getLayoutValue("text-allow-overlap",r),textIgnorePlacement:i.getLayoutValue("text-ignore-placement",r),iconRotationAlignment:a,textRotationAlignment:s,iconTranslateAnchor:o,iconTranslate:l,textTranslateAnchor:u,textTranslate:c};return this._styleProps.set(e,h),h}}]),e}();function we(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Se(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Se(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function Se(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function ke(e,t){if(e.priority-t.priority)return e.priority-t.priority;var r=e.tile.key,i=t.tile.key;return r.world-i.world?r.world-i.world:r.level-i.level?r.level-i.level:r.row-i.row?r.row-i.row:r.col-i.col?r.col-i.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}var Oe=function(){function e(t,r,i,a,s,l){Object(n.a)(this,e),this._visibleTiles=t,this._symbolRepository=r,this._createCollisionJob=i,this._assignTileSymbolsOpacity=a,this._symbolLayerSorter=s,this._isLayerVisible=l,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}return Object(a.a)(e,[{key:"running",get:function(){return this._running}},{key:"setScreenSize",value:function(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}},{key:"restart",value:function(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}},{key:"continue",value:function(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){var t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){var r=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-r))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){var i=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-i))))return!1}return this._running=!1,!0}},{key:"_createSelectionJob",value:function(){var e=this._symbolRepository.uniqueSymbols,t=[],r=0,i=0,n=this._isLayerVisible;var a=this._symbolLayerSorter;return{work:function(a){for(var s,l=performance.now();i<e.length;i++,r=0){var o=e[i],c=o.styleLayerUID;if(n(c)){t[i]=t[i]||{styleLayerUID:c,symbols:[]};for(var u=t[i];r<o.uniqueSymbols.length;r++){if(s=o.uniqueSymbols[r],r%100==99&&performance.now()-l>a)return!1;var h,f=null,y=!1,d=!1,v=we(s.tileSymbols);try{for(v.s();!(h=v.n()).done;){var p=h.value;if(p.selectedForRendering=!1,!d||!y){var _=p.tile;(!f||_.isCoverage||_.neededForCoverage&&!y)&&(f=p,(_.neededForCoverage||_.isCoverage)&&(d=!0),_.isCoverage&&(y=!0))}}}catch(S){v.e(S)}finally{v.f()}if(f.selectedForRendering=!0,d){u.symbols.push(f),s.show=!0;var b,g=we(s.parts);try{for(g.s();!(b=g.n()).done;){b.value.show=!0}}catch(S){g.e(S)}finally{g.f()}}else s.show=!1}}else t[i]||(t[i]={styleLayerUID:c,symbols:[]})}var m,w=we(t);try{for(w.s();!(m=w.n()).done;){m.value.symbols.sort(ke)}}catch(S){w.e(S)}finally{w.f()}return!0},get sortedSymbols(){return t.sort(a)}}}},{key:"_createOpacityJob",value:function(){var e=this._assignTileSymbolsOpacity,t=this._visibleTiles,r=0;function i(t,r){var n,a=we(t.symbols);try{for(a.s();!(n=a.n()).done;){var s=Object(H.a)(n.value,2);s[0];Te(s[1],r)}}catch(c){a.e(c)}finally{a.f()}e(t,r);var l,o=we(t.childrenTiles);try{for(o.s();!(l=o.n()).done;){i(l.value,r)}}catch(c){o.e(c)}finally{o.f()}}return{work:function(e){for(var n=performance.now();r<t.length;r++){if(performance.now()-n>e)return!1;var a=t[r];Object(b.i)(a.parentTile)||i(a,performance.now())}return!0}}}}]),e}();function Te(e,t){var r,i=we(e);try{for(i.s();!(r=i.n()).done;){var n,a=r.value.unique,s=we(a.parts);try{for(s.s();!(n=s.n()).done;){var l=n.value,o=l.targetOpacity>.5?1:-1;l.startOpacity+=o*((t-l.startTime)/ye.d),l.startOpacity=Math.min(Math.max(l.startOpacity,0),1),l.startTime=t,l.targetOpacity=a.show&&l.show?1:0}}catch(c){s.e(c)}finally{s.f()}}}catch(c){i.e(c)}finally{i.f()}}r("Se8w");function xe(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return je(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return je(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function je(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}var Ce=function(){function e(t,r,i){Object(n.a)(this,e),this.tileCoordRange=t,this._visibleTiles=r,this._createUnique=i,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}return Object(a.a)(e,[{key:"uniqueSymbols",get:function(){return Object(b.h)(this._uniqueSymbolLayerArray)&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}},{key:"add",value:function(e,t){this._uniqueSymbolLayerArray=null;var r=this._tiles.get(e.id);r||(r={symbols:new Map},this._tiles.set(e.id,r));var i=new Map;if(t){var n,a=xe(t);try{for(a.s();!(n=a.n()).done;){var s=n.value;r.symbols.has(s)&&(i.set(s,r.symbols.get(s)),r.symbols.delete(s))}}catch(O){a.e(O)}finally{a.f()}}else{var l,o=xe(e.layerData);try{for(o.s();!(l=o.n()).done;){var c=Object(H.a)(l.value,2),u=c[0];c[1];r.symbols.has(u)&&(i.set(u,r.symbols.get(u)),r.symbols.delete(u))}}catch(O){o.e(O)}finally{o.f()}}this._removeSymbols(i);var h,f=e.symbols,y=new Map,d=xe(f);try{for(d.s();!(h=d.n()).done;){var v=Object(H.a)(h.value,2),p=v[0],_=v[1],b=_.length;if(b>=32){var g=this.tileCoordRange;do{g/=2,b/=4}while(b>8&&g>64);var m=new pe.a(this.tileCoordRange,this.tileCoordRange,g);y.set(p,{flat:_,index:m}),r.symbols.set(p,{flat:_,index:m});var w,S=xe(_);try{for(S.s();!(w=S.n()).done;){var k=w.value;m.getCell(k.xTile,k.yTile).push(k)}}catch(O){S.e(O)}finally{S.f()}}else y.set(p,{flat:_}),r.symbols.set(p,{flat:_})}}catch(O){d.e(O)}finally{d.f()}this._addSymbols(e.key,f)}},{key:"deleteStyleLayers",value:function(e){this._uniqueSymbolLayerArray=null;var t,r=xe(this._tiles);try{for(r.s();!(t=r.n()).done;){var i,n=Object(H.a)(t.value,2),a=n[0],s=n[1],l=new Map,o=xe(e);try{for(o.s();!(i=o.n()).done;){var c=i.value;s.symbols.has(c)&&(l.set(c,s.symbols.get(c)),s.symbols.delete(c))}}catch(u){o.e(u)}finally{o.f()}this._removeSymbols(l),0===s.symbols.size&&this._tiles.delete(a)}}catch(u){r.e(u)}finally{r.f()}}},{key:"removeTile",value:function(e){this._uniqueSymbolLayerArray=null;var t=this._tiles.get(e.id);if(t){var r,i=new Map,n=xe(e.symbols);try{for(n.s();!(r=n.n()).done;){var a=Object(H.a)(r.value,2),s=a[0];a[1];t.symbols.has(s)&&(i.set(s,t.symbols.get(s)),t.symbols.delete(s))}}catch(l){n.e(l)}finally{n.f()}this._removeSymbols(i),0===t.symbols.size&&this._tiles.delete(e.id)}}},{key:"_removeSymbols",value:function(e){var t,r=xe(e);try{for(r.s();!(t=r.n()).done;){var i,n=Object(H.a)(t.value,2),a=n[0],s=xe(n[1].flat);try{for(s.s();!(i=s.n()).done;){for(var l=i.value,o=l.unique,c=o.tileSymbols,u=c.length-1,h=0;h<u;h++)if(c[h]===l){c[h]=c[u];break}if(c.length=u,0===u){var f=this._uniqueSymbolsReferences.get(a);f.delete(o),0===f.size&&this._uniqueSymbolsReferences.delete(a)}l.unique=null}}catch(y){s.e(y)}finally{s.f()}}}catch(y){r.e(y)}finally{r.f()}}},{key:"_addSymbols",value:function(e,t){if(0!==t.size){var r,i=xe(this._visibleTiles);try{for(i.s();!(r=i.n()).done;){var n=r.value;n.parentTile||n.key.world!==e.world||n.key.level===e.level&&!n.key.equals(e)||this._matchSymbols(n,e,t)}}catch(d){i.e(d)}finally{i.f()}var a,s=xe(t);try{for(s.s();!(a=s.n()).done;){var l,o=Object(H.a)(a.value,2),c=o[0],u=xe(o[1]);try{for(u.s();!(l=u.n()).done;){var h=l.value;if(Object(b.h)(h.unique)){var f=this._createUnique();h.unique=f,f.tileSymbols.push(h);var y=this._uniqueSymbolsReferences.get(c);y||(y=new Set,this._uniqueSymbolsReferences.set(c,y)),y.add(f)}}}catch(d){u.e(d)}finally{u.f()}}}catch(d){s.e(d)}finally{s.f()}}}},{key:"_matchSymbols",value:function(e,t,r){if(e.key.level>t.level){var i=e.key.level-t.level;if(e.key.row>>i!==t.row||e.key.col>>i!==t.col)return}if(t.level>e.key.level){var n=t.level-e.key.level;if(t.row>>n!==e.key.row||t.col>>n!==e.key.col)return}if(t.equals(e.key)){var a,s=xe(e.childrenTiles);try{for(s.s();!(a=s.n()).done;){var l=a.value;this._matchSymbols(l,t,r)}}catch(E){s.e(E)}finally{s.f()}}else{var o,c=new Map,u=xe(r);try{for(u.s();!(o=u.n()).done;){var h,f=Object(H.a)(o.value,2),y=f[0],d=f[1],v=[],p=xe(d);try{for(p.s();!(h=p.n()).done;){var _=h.value,g=Object(pe.c)(this.tileCoordRange,_.xTile,t.level,t.col,e.key.level,e.key.col),m=Object(pe.c)(this.tileCoordRange,_.yTile,t.level,t.row,e.key.level,e.key.row);g>=0&&g<this.tileCoordRange&&m>=0&&m<this.tileCoordRange&&v.push({symbol:_,xTransformed:g,yTransformed:m})}}catch(E){p.e(E)}finally{p.f()}var w=[],S=e.key.level<t.level?1:1<<e.key.level-t.level,k=this._tiles.get(e.id).symbols.get(y);if(k){var O,T=k.flat,x=xe(v);try{for(x.s();!(O=x.n()).done;){var j,C=O.value,I=!1,R=C.xTransformed,P=C.yTransformed;j=Object(b.i)(k.index)?k.index.getCell(R,P):T;var M,D=C.symbol,L=D.hash,A=xe(j);try{for(A.s();!(M=A.n()).done;){var U=M.value;if(L===U.hash&&Math.abs(R-U.xTile)<=S&&Math.abs(P-U.yTile)<=S){var z=U.unique;D.unique=z,z.tileSymbols.push(D),I=!0;break}}}catch(E){A.e(E)}finally{A.f()}I||w.push(D)}}catch(E){x.e(E)}finally{x.f()}}w.length>0&&c.set(y,w)}}catch(E){u.e(E)}finally{u.f()}var q,F=xe(e.childrenTiles);try{for(F.s();!(q=F.n()).done;){var V=q.value;this._matchSymbols(V,t,c)}}catch(E){F.e(E)}finally{F.f()}}}},{key:"_createUniqueSymbolLayerArray",value:function(){var e,t,r=this._uniqueSymbolsReferences,i=new Array(r.size),n=0,a=xe(r);try{for(a.s();!(t=a.n()).done;){var s=Object(H.a)(t.value,2),l=s[0],o=s[1],c=new Array(o.size);e=0;var u,h=xe(o);try{for(h.s();!(u=h.n()).done;){var f=u.value;c[e++]=f}}catch(y){h.e(y)}finally{h.f()}i[n]={styleLayerUID:l,uniqueSymbols:c},n++}}catch(y){a.e(y)}finally{a.f()}return i}}]),e}();function Ie(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Object(c.a)(e);if(t){var n=Object(c.a)(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return Object(o.a)(this,r)}}var Re=function(e){Object(l.a)(r,e);var t=Ie(r);function r(e,i){var a;return Object(n.a)(this,r),(a=t.call(this)).styleRepository=e,a._tileToHandle=new Map,a._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},a._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},a._completed=!1,a._symbolRepository=new Ce(4096,i,(function(){return new de.b})),a._symbolDeclutterer=new Oe(i,a._symbolRepository,(function(e,t,r){return new me(e,t,r,a.styleRepository,a._zoom,a._viewState.rotation)}),(function(e,t){e.allSymbolsFadingOut=!0,e.lastOpacityUpdate=t,Object(pe.d)(e,t,!0),e.decluttered=!0,e.requestRender()}),(function(e,t){return a.styleRepository.getStyleLayerByUID(e.styleLayerUID).z-a.styleRepository.getStyleLayerByUID(t.styleLayerUID).z}),(function(e){var t=a.styleRepository.getStyleLayerByUID(e).getLayoutProperty("visibility");return!t||1!==t.getValue()})),a}return Object(a.a)(r,[{key:"addTile",value:function(e){var t=this;e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",(function(){t._symbolRepository.add(e),t.restartDeclutter()}))),this._symbolRepository.add(e),this.restartDeclutter()}},{key:"removeTile",value:function(e){var t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}},{key:"update",value:function(e,t){return this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]},this._continueDeclutter(),this._completed}},{key:"restartDeclutter",value:function(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}},{key:"clear",value:function(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach((function(e){return e.remove()})),this._tileToHandle.clear()}},{key:"stale",get:function(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}},{key:"deleteStyleLayers",value:function(e){this._symbolRepository.deleteStyleLayers(e)}},{key:"_continueDeclutter",value:function(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(ye.b),this._completed&&this._scheduleNotifyStable())}},{key:"_scheduleNotifyStable",value:function(){var e=this;Object(b.i)(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout((function(){e._stableNotificationHandle=null,e.emit("fade-complete")}),1.5*ye.d)}},{key:"_notifyUnstable",value:function(){Object(b.i)(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}]),r}(fe.a),Pe=r("FNqF"),Me=r("ezmY"),De=r("QPvm");function Le(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function Ae(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Le(Object(r),!0).forEach((function(t){Object(T.a)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Le(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function Ue(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return ze(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ze(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function ze(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function qe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Object(c.a)(e);if(t){var n=Object(c.a)(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return Object(o.a)(this,r)}}function He(e,t){if(e){var r=e.getLayoutProperty("visibility");if(!r||1!==r.getValue()&&(void 0===e.minzoom||e.minzoom<t+1e-6)&&(void 0===e.maxzoom||e.maxzoom>=t-1e-6))return!0}return!1}var Fe=function(e){Object(l.a)(o,e);var t,r=qe(o);function o(e){var t;return Object(n.a)(this,o),(t=r.call(this,e))._backgroundTiles=[],t._pointToCallbacks=new Map,t._fading=!1,t}return Object(a.a)(o,[{key:"destroy",value:function(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),Object(b.i)(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}},{key:"setStyleResources",value:function(e,t,r){var i=this;if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=r,Object(b.h)(this._symbolFader)){var n=new Re(this._styleRepository,this.children);n.on("fade-start",(function(){i.emit("fade-start"),i._fading=!0,i.requestRender()})),n.on("fade-complete",(function(){i.emit("fade-complete"),i._fading=!1,i.requestRender()})),this._symbolFader=n}Object(b.p)(this._symbolFader).styleRepository=r}},{key:"deleteStyleLayers",value:function(e){Object(b.i)(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)}},{key:"hitTest",value:(t=Object(i.a)(h.a.mark((function e(t,r){var i,n;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=[t,r],n=Object(g.g)(),e.abrupt("return",(this._pointToCallbacks.set(i,n),this.requestRender(),n.promise));case 2:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"enterTileInvalidation",value:function(){var e,t=Ue(this.children);try{for(t.s();!(e=t.n()).done;){e.value.invalidating=!0}}catch(r){t.e(r)}finally{t.f()}}},{key:"createRenderParams",value:function(e){return Ae(Ae({},Object(s.a)(Object(c.a)(o.prototype),"createRenderParams",this).call(this,e)),{},{renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos})}},{key:"doRender",value:function(e){!this.visible||e.drawPhase!==Pe.c.MAP&&e.drawPhase!==Pe.c.DEBUG||void 0===this._spriteMosaic||Object(s.a)(Object(c.a)(o.prototype),"doRender",this).call(this,e)}},{key:"addChild",value:function(e){return Object(s.a)(Object(c.a)(o.prototype),"addChild",this).call(this,e),Object(b.i)(this._symbolFader)?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}},{key:"removeChild",value:function(e){return Object(b.i)(this._symbolFader)&&this._symbolFader.removeTile(e),this.requestRender(),Object(s.a)(Object(c.a)(o.prototype),"removeChild",this).call(this,e)}},{key:"renderChildren",value:function(e){if(e.drawPhase!==Pe.c.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){var t=e.context,r=t.getBoundFramebufferObject();e.drawPhase=Pe.c.HITTEST;var i=e.painter.effects.hittest;i.bind(e),this._doRender(e),i.draw(e,this._pointToCallbacks),t.bindFramebuffer(r)}}else Object(s.a)(Object(c.a)(o.prototype),"renderChildren",this).call(this,e)}},{key:"removeAllChildren",value:function(){for(var e=0;e<this.children.length;e++){var t=this.children[e];Object(b.i)(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}Object(s.a)(Object(c.a)(o.prototype),"removeAllChildren",this).call(this)}},{key:"getStencilTarget",value:function(){return this.children.filter((function(e){return e.neededForCoverage&&e.hasData()}))}},{key:"restartDeclutter",value:function(){Object(b.i)(this._symbolFader)&&this._symbolFader.restartDeclutter()}},{key:"_doRender",value:function(e){var t=this,r=e.context,i=this._styleRepository;if(i){var n=i.layers,a=!0;e.drawPhase===Pe.c.HITTEST&&(a=!1),i.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,i.backgroundBucketIds)),Object(s.a)(Object(c.a)(o.prototype),"renderChildren",this).call(this,e),e.drawPhase===Pe.c.MAP&&this._fade(e.displayLevel,e.state);var l=this.children.filter((function(e){return e.visible&&e.hasData()}));if(l&&0!==l.length){var u,h=Ue(l);try{for(h.s();!(u=h.n()).done;){u.value.triangleCount=0}}catch(k){h.e(k)}finally{h.f()}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(7680,7680,7681),r.setStencilTestEnabled(!0),r.setBlendingEnabled(!1),r.setDepthTestEnabled(!0),r.setDepthWriteEnabled(!0),r.setDepthFunction(515),r.setClearDepth(1),r.clear(r.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(var f=n.length-1;f>=0;f--)this._renderStyleLayer(n[f],e,l);r.setDepthWriteEnabled(!1),r.setBlendingEnabled(a),r.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent";for(var y=0;y<n.length;y++)this._renderStyleLayer(n[y],e,l);r.setDepthTestEnabled(!1),e.renderPass="symbol";for(var d=0;d<n.length;d++)this._renderStyleLayer(n[d],e,l);if(r.bindVAO(),r.setStencilTestEnabled(!0),r.setBlendingEnabled(!0),e.drawPhase===Pe.c.MAP){var v=window.COLLISION_DEBUG_CTX;if(v&&Object(b.i)(this._symbolFader)&&(v.clearRect(0,0,v.canvas.width,v.canvas.height),!this._fading||window.COLLISION_XRAY)){var p,_=Ue(this.children);try{for(_.s();!(p=_.n()).done;){var g,m,w,S=p.value;if(S.symbols)!function(){var e=[];if(S.symbols.forEach((function(t){e.push.apply(e,Object(he.a)(t))})),window.COLLISION_SHOW_GRID){var r=null==(g=t._symbolFader)||null==(m=g._symbolDeclutterer)||null==(w=m._collisionJob)?void 0:w._gridIndex;r&&K(v,r)}$(v,e)}()}}catch(k){_.e(k)}finally{_.f()}}}}}}},{key:"_fade",value:function(e,t){Object(b.i)(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())}},{key:"_renderStyleLayer",value:function(e,t,r){var i=t.painter,n=t.renderPass;if(void 0!==e){var a=e.getLayoutProperty("visibility");if(!a||1!==a.getValue()){var s;switch(e.type){case 0:return;case 1:if("opaque"!==n&&"translucent"!==t.renderPass)return;s="vtlFill";break;case 2:if("translucent"!==n)return;s="vtlLine";break;case 4:if("symbol"!==n)return;s="vtlCircle";break;case 3:if("symbol"!==n)return;s="vtlSymbol"}if(r=3===e.type?r.filter((function(e){return e.decluttered})):r.filter((function(e){return e.neededForCoverage})),"vtlSymbol"!==s){var l=t.displayLevel;if(0===r.length||void 0!==e.minzoom&&e.minzoom>=l+1e-6||void 0!==e.maxzoom&&e.maxzoom<l-1e-6)return}var o=e.uid;t.styleLayerUID=o,t.styleLayer=e;var c,u=Ue(r);try{for(u.s();!(c=u.n()).done;){if(c.value.layerData.has(o)){i.renderObjects(t,r,s);break}}}catch(h){u.e(h)}finally{u.f()}}}}},{key:"_renderBackgroundLayers",value:function(e,t){var r,i=e.context,n=e.displayLevel,a=e.painter,s=e.state,l=this._styleRepository,o=!1,c=Ue(t);try{for(c.s();!(r=c.n()).done;){var u=r.value;if(He(l.getLayerById(u),n)){o=!0;break}}}catch(U){c.e(U)}finally{c.f()}if(o){var h=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),f=h.spans,y=h.lodInfo,d=y.level,v=Object(O.g)(),p=[];if(this._renderPasses){var _=this._renderPasses[0];Object(b.i)(this._clippingInfos)&&(_.brushes[0].prepareState(e,this._clippingInfos[0]),_.brushes[0].drawMany(e,this._clippingInfos))}var g,m,w=this._backgroundTiles,S=0,k=Ue(f);try{for(k.s();!(m=k.n()).done;)for(var T=m.value,x=T.row,j=T.colFrom,C=T.colTo,I=j;I<=C;I++){if(S<w.length)(g=w[S]).key.set(d,x,y.normalizeCol(I),y.getWorldForColumn(I)),this._tileInfoView.getTileBounds(v,g.key,!1),g.bounds=v,g.coords[0]=v[0],g.coords[1]=v[3];else{var R=new Y.a(d,x,y.normalizeCol(I),y.getWorldForColumn(I));g=new De.a(R,this._tileInfoView.getTileBounds(Object(O.g)(),R),[512,512],[4096,4096]),w.push(g)}g.setTransform(s,this._tileInfoView.getTileResolution(g.key)),p.push(g),S++}}catch(U){k.e(U)}finally{k.f()}i.setStencilWriteMask(0),i.setColorMask(!0,!0,!0,!0),i.setStencilOp(7680,7680,7681),i.setStencilFunction(514,0,255);var P=!0;e.drawPhase===Pe.c.HITTEST&&(P=!1),i.setStencilTestEnabled(P);var M,D=Ue(t);try{for(D.s();!(M=D.n()).done;){var L=M.value,A=l.getLayerById(L);He(A,n)&&(e.styleLayerUID=A.uid,e.styleLayer=A,a.renderObjects(e,p,"vtlBackground"))}}catch(U){D.e(U)}finally{D.f()}ne.a.pool.release(h)}}}]),o}(Me.a),Ve=r("IjGd"),Ee=r("55C+"),Be=r("eDEE");function Qe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Object(c.a)(e);if(t){var n=Object(c.a)(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return Object(o.a)(this,r)}}var Je=function(e){Object(l.a)(r,e);var t=Qe(r);function r(){var e;return Object(n.a)(this,r),(e=t.apply(this,arguments))._fullCacheLodInfos=null,e._levelByScale={},e}return Object(a.a)(r,[{key:"getTileParentId",value:function(e){var t=Y.a.pool.acquire(e),r=0===t.level?null:Y.a.getId(t.level-1,t.row>>1,t.col>>1,t.world);return Y.a.pool.release(t),r}},{key:"getTileCoverage",value:function(e,t,i){var n=Object(s.a)(Object(c.a)(r.prototype),"getTileCoverage",this).call(this,e,t,i);if(!n)return n;var a=1<<n.lodInfo.level;return n.spans=n.spans.filter((function(e){return e.row>=0&&e.row<a})),n}},{key:"scaleToLevel",value:function(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];var t,r,i=this._fullCacheLodInfos;if(e>i[0].scale)return i[0].level;for(var n=0;n<i.length-1;n++)if(e>(r=i[n+1]).scale)return(t=i[n]).level+(t.scale-e)/(t.scale-r.scale);return i[i.length-1].level}},{key:"_initializeFullCacheLODs",value:function(e){var t;if(0===e[0].level)t=e.map((function(e){return{level:e.level,resolution:e.resolution,scale:e.scale}}));else{var r=this.tileInfo.size[0],i=this.tileInfo.spatialReference;t=Be.a.create({size:r,spatialReference:i}).lods.map((function(e){return{level:e.level,resolution:e.resolution,scale:e.scale}}))}for(var n=0;n<t.length;n++)this._levelByScale[t[n].scale]=t[n].level;this._fullCacheLodInfos=t}}]),r}(r("xTsm").a),Ne=r("0s/2"),We=r("bPf0");function Ge(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Ke(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Ke(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,l=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){l=!0,a=e},f:function(){try{s||null==r.return||r.return()}finally{if(l)throw a}}}}function Ke(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function $e(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Object(c.a)(e);if(t){var n=Object(c.a)(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return Object(o.a)(this,r)}}var Ye=_.a.getLogger("esri.views.2d.layers.VectorTileLayerView2D"),Xe=function(e){Object(l.a)(m,e);var t,r,o,u,f,_=$e(m);function m(){var e;return Object(n.a)(this,m),(e=_.apply(this,arguments))._styleChanges=[],e._handles=new v.a,e._fetchQueue=null,e._parseQueue=null,e._isTileHandlerReady=!1,e.fading=!1,e}return Object(a.a)(m,[{key:"initialize",value:function(){var e=this,t=this.layer.tileInfo;if((t&&t.spatialReference).equals(this.view.spatialReference)){var r=this.layer.currentStyleInfo,i=r.style,n=r.spriteUrl,a=r.glyphsUrl;this._styleRepository=new Ve.a(i,{spriteUrl:n,glyphsUrl:a}),this._tileInfoView=new Je(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Fe(this._tileInfoView),this._tileHandler=new re(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this.handles.add([this._vectorTileContainer.on("fade-start",(function(){e.fading=!0,e.notifyChange("updating"),e.requestUpdate()})),this._vectorTileContainer.on("fade-complete",(function(){e.fading=!1,e.notifyChange("updating"),e.requestUpdate()}))])}else this.addResolvingPromise(Promise.reject(new d.a("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer})))}},{key:"destroy",value:function(){var e;this._stop(),this.container.removeAllChildren(),this._vectorTileContainer&&(this._vectorTileContainer.destroy(),this._vectorTileContainer=null),null==(e=this._tileHandler)||e.destroy(),this._tileHandler=null}},{key:"hitTest",value:(f=Object(i.a)(h.a.mark((function e(t,r){var i,n,a,s,l,o;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.suspended&&this._tileHandlerPromise){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,this._tileHandlerPromise;case 4:return e.next=6,this._vectorTileContainer.hitTest(t,r);case 6:if((i=e.sent)&&0!==i.length){e.next=9;break}return e.abrupt("return",null);case 9:if(n=i[0]-1,a=this._styleRepository,s=a.getStyleLayerByUID(n)){e.next=12;break}return e.abrupt("return",null);case 12:return l=a.getStyleLayerIndex(s.id),o=new y.a({attributes:{layerId:l,layerName:s.id,layerUID:n}}),e.abrupt("return",(o.layer=this.layer,o.sourceLayer=this.layer,o));case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"update",value:function(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}},{key:"attach",value:function(){var e=this;this._start(),this._handles.add([this.layer.on("paint-change",(function(t){if(t.isDataDriven)e._styleChanges.push({type:0,data:t}),e.notifyChange("updating"),e.requestUpdate();else{var r=e._styleRepository,i=r.getLayerById(t.layer);if(!i)return;var n=3===i.type;r.setPaintProperties(t.layer,t.paint),n&&e._vectorTileContainer.restartDeclutter(),e._vectorTileContainer.requestRender()}})),this.layer.on("layout-change",(function(t){var r=e._styleRepository,i=r.getLayerById(t.layer);if(i){var n=Object(k.a)(i.layout,t.layout);if(!Object(b.h)(n)){if(Object(k.b)(n,"visibility")&&1===function(e){if(Object(b.h)(e))return 0;switch(e.type){case"partial":return Object.keys(e.diff).length;case"complete":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case"collection":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}(n))return r.setLayoutProperties(t.layer,t.layout),3===i.type&&e._vectorTileContainer.restartDeclutter(),void e._vectorTileContainer.requestRender();e._styleChanges.push({type:1,data:t}),e.notifyChange("updating"),e.requestUpdate()}}})),this.layer.on("style-layer-visibility-change",(function(t){var r=e._styleRepository,i=r.getLayerById(t.layer);i&&(r.setStyleLayerVisibility(t.layer,t.visibility),3===i.type&&e._vectorTileContainer.restartDeclutter(),e._vectorTileContainer.requestRender())})),this.layer.on("style-layer-change",(function(t){e._styleChanges.push({type:2,data:t}),e.notifyChange("updating"),e.requestUpdate()})),this.layer.on("delete-style-layer",(function(t){e._styleChanges.push({type:3,data:t}),e.notifyChange("updating"),e.requestUpdate()})),this.layer.on("load-style",(function(){return e._loadStyle()}))])}},{key:"detach",value:function(){this._stop(),this._handles.removeAll()}},{key:"moveStart",value:function(){this.requestUpdate()}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"moveEnd",value:function(){this.requestUpdate()}},{key:"canResume",value:function(){var e=Object(s.a)(Object(c.a)(m.prototype),"canResume",this).call(this),t=this.layer;if(e&&t.currentStyleInfo){var r=this.view.scale,i=t.currentStyleInfo;if(i&&i.layerDefinition){var n=i.layerDefinition;n.minScale&&n.minScale<r&&(e=!1),n.maxScale&&n.maxScale>r&&(e=!1)}}return e}},{key:"isUpdating",value:function(){var e=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||e.length>0&&e.filter((function(e){return e.invalidating})).length>0||this.fading}},{key:"acquireTile",value:function(e){var t=this,r=this._createVectorTile(e);return this._tileHandlerPromise.then((function(){t._fetchQueue.push(r.key).then((function(e){return t._parseQueue.push({key:r.key,data:e})})).then((function(e){r.once("attach",(function(){return t.requestUpdate()})),e&&(r.setData(e.tileData),t.requestUpdate(),t.notifyChange("updating"))})).catch((function(e){t.notifyChange("updating"),Object(g.m)(e)||Ye.error(e)}))})),r}},{key:"releaseTile",value:function(e){var t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}},{key:"_start",value:function(){var e=this;if(this._stop(),this._tileManager=new oe({acquireTile:function(t){return e.acquireTile(t)},releaseTile:function(t){return e.releaseTile(t)},tileInfoView:this._tileInfoView},this._vectorTileContainer),this.layer.currentStyleInfo){var t=new AbortController,r=this._tileHandler.start({signal:t.signal}).then((function(){e._fetchQueue=new Ne.a({tileInfoView:e._tileInfoView,process:function(t,r){return e._getTileData(t,r)},concurrency:15}),e._parseQueue=new Ne.a({tileInfoView:e._tileInfoView,process:function(t,r){return e._parseTileData(t,r)},concurrency:8}),e.requestUpdate(),e._isTileHandlerReady=!0}));this._tileHandler.spriteMosaic.then((function(t){e._vectorTileContainer.setStyleResources(t,e._tileHandler.glyphMosaic,e._styleRepository),e.requestUpdate()})),this._tileHandlerAbortController=t,this._tileHandlerPromise=r}}},{key:"_stop",value:function(){if(this._tileHandlerAbortController&&this._vectorTileContainer){var e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}}},{key:"_getTileData",value:(u=Object(i.a)(h.a.mark((function e(t,r){var i;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tileHandler.fetchTileData(t,r);case 2:return i=e.sent,e.abrupt("return",(this.notifyChange("updating"),i));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"_parseTileData",value:(o=Object(i.a)(h.a.mark((function e(t,r){return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._tileHandler.parseTileData(t,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"_applyStyleChanges",value:(r=Object(i.a)(h.a.mark((function e(){var t,r,i,n,a,s,l,o,c,u,f,y,d=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache(),t=this._styleChanges,e.prev=2,e.next=5,this._tileHandler.updateStyle(t);case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),Ye.error("error applying vector-tiles style update",e.t0.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0;case 10:if(r=this._styleRepository,i=[],t.forEach((function(e){if(3===e.type){var t=e.data,n=r.getLayerById(t.layer);n&&i.push(n.uid)}})),n=[],t.forEach((function(e){var t=e.type,i=e.data;switch(t){case 0:r.setPaintProperties(i.layer,i.paint),a=i.layer;break;case 1:r.setLayoutProperties(i.layer,i.layout),a=i.layer;break;case 3:return void r.deleteStyleLayer(i.layer);case 2:r.setStyleLayer(i.layer,i.index),a=i.layer.id}var s=r.getLayerById(a);s&&n.push(s.uid)})),s=this._vectorTileContainer.children,i.length>0){this._vectorTileContainer.deleteStyleLayers(i),l=Ge(s);try{for(l.s();!(o=l.n()).done;)o.value.deleteLayerData(i)}catch(h){l.e(h)}finally{l.f()}}if(this._fetchQueue.resume(),this._parseQueue.resume(),!(n.length>0)){e.next=22;break}c=[],u=Ge(s);try{for(y=function(){var e=f.value,t=d._fetchQueue.push(e.key).then((function(t){return d._parseQueue.push({key:e.key,data:t,styleLayerUIDs:n})})).then((function(t){return e.setData(t.tileData)}));c.push(t)},u.s();!(f=u.n()).done;)y()}catch(h){u.e(h)}finally{u.f()}return e.next=22,Promise.all(c);case 22:this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();case 23:case"end":return e.stop()}}),e,this,[[2,7]])}))),function(){return r.apply(this,arguments)})},{key:"_loadStyle",value:(t=Object(i.a)(h.a.mark((function e(){var t,r,i,n,a,s,l;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.layer.currentStyleInfo,r=t.style,i=t.spriteUrl,n=t.glyphsUrl,a=Object(p.a)(r),this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new Ve.a(a,{spriteUrl:i,glyphsUrl:n}),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=Object(g.d)(),s=this._tileHandlerAbortController.signal,e.prev=3,this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,a),e.next=7,this._tileHandlerPromise;case 7:e.next=13;break;case 9:if(e.prev=9,e.t0=e.catch(3),Object(g.m)(e.t0)){e.next=13;break}throw e.t0;case 13:if(!s.aborted){e.next=15;break}return e.abrupt("return",(this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate()));case 15:return e.next=17,this._tileHandler.spriteMosaic;case 17:l=e.sent,this._vectorTileContainer.setStyleResources(l,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();case 19:case"end":return e.stop()}}),e,this,[[3,9]])}))),function(){return t.apply(this,arguments)})},{key:"_createVectorTile",value:function(e){var t=this._tileInfoView.getTileBounds(Object(O.g)(),e);return new ue.a(e,this._styleRepository,t,[512,512])}}]),m}(Object(Ee.a)(We.a));Object(f.a)([Object(m.b)()],Xe.prototype,"_fetchQueue",void 0),Object(f.a)([Object(m.b)()],Xe.prototype,"_parseQueue",void 0),Object(f.a)([Object(m.b)()],Xe.prototype,"_isTileHandlerReady",void 0),Object(f.a)([Object(m.b)()],Xe.prototype,"suspended",void 0),Object(f.a)([Object(m.b)()],Xe.prototype,"fading",void 0),Object(f.a)([Object(m.b)()],Xe.prototype,"updating",void 0);var Ze=Xe=Object(f.a)([Object(S.a)("esri.views.2d.layers.VectorTileLayerView2D")],Xe);t.default=Ze}}]);
//# sourceMappingURL=166-bba98ae9e152daf87668.js.map