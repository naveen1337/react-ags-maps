(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{B9qS:function(e,t,r){"use strict";r.r(t);var i=r("aNYv"),a=r("eijD"),s=r("hisu"),n=r("yBJb"),l=r("CHlC"),o=r("kMo5"),u=r("P+uj"),c=r("NthX"),h=r.n(c),f=r("dQW7"),p=(r("ZTBZ"),r("4VMI")),d=r("TM+E"),m=r("7im+"),b=r("IH5m"),y=r("frPA"),_=r("j56I"),v=r("xAIp"),g=(r("J4Pc"),r("wckI"),r("iaHD")),x=r("sE9J"),T=r("eDEE"),O=r("Ufyo"),j=r("WBSb"),k=r("lWwP"),w=r("6CzD"),I=r("4Mpa"),R=r("+MdM"),P=r("kBLL"),S=r("gj5F"),C=r("+MBG"),U=r("Tkaf"),z=r("0s7n"),B=r("PFYi"),V=r("jgfI");function G(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Object(u.a)(e);if(t){var a=Object(u.a)(this).constructor;r=Reflect.construct(i,arguments,a)}else r=i.apply(this,arguments);return Object(o.a)(this,r)}}var F={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"},D=function(e){Object(l.a)(r,e);var t=G(r);function r(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return Object(s.a)(this,r),(e=t.call(this))._textureInvalidated=!0,e._memoryUsed=null,e._supportsBilinear=!0,e.stencilRef=0,e.coordScale=[1,1],e._symbolizerParameters=null,e.height=null,e.isRendereredSource=!1,e.pixelRatio=1,e.resolution=0,e.rotation=0,e._source=null,e.rawPixelData=null,e._suspended=!1,e._bandIds=null,e._interpolation=null,e._transformGrid=null,e.width=null,e.x=0,e.y=0,e.transforms={dvs:Object(U.b)()},e.source=i,e.transformGrid=a,e.interpolation=n,e}return Object(n.a)(r,[{key:"destroy",value:function(){var e=this.getTextures();null==e||e.textures.forEach((function(e){return e.dispose()})),this._rasterTexture=null,this._transformGridTexture=null,this._colormapTexture=null}},{key:"symbolizerParameters",get:function(){return this._symbolizerParameters||F},set:function(e){this._symbolizerParameters=e}},{key:"source",get:function(){return this._source},set:function(e){this._source=e,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null,this._memoryUsed=null)}},{key:"suspended",get:function(){return this._suspended},set:function(e){this._suspended&&!e&&this.stage&&(this.ready(),this.requestRender()),this._suspended=e}},{key:"bandIds",get:function(){return this._bandIds},set:function(e){this._bandIds=e,this.invalidateTexture()}},{key:"interpolation",get:function(){return this._interpolation},set:function(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode(!this._supportsBilinear||"bilinear"!==e&&"cubic"!==e?9728:9729)}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(e){this._transformGrid=e,this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null,this._memoryUsed=null)}},{key:"invalidateTexture",value:function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}},{key:"setTransform",value:function(e){var t=Object(C.b)(this.transforms.dvs),r=e.toScreenNoRotation([0,0],this.x,this.y),a=Object(i.a)(r,2),s=a[0],n=a[1],l=this.resolution/this.pixelRatio/e.resolution,o=l*this.width,u=l*this.height,c=Math.PI*this.rotation/180;Object(C.c)(t,t,Object(z.b)(s,n)),Object(C.c)(t,t,Object(z.b)(o/2,u/2)),Object(C.j)(t,t,-c),Object(C.c)(t,t,Object(z.b)(-o/2,-u/2)),Object(C.g)(t,t,Object(z.b)(o,u)),Object(C.h)(this.transforms.dvs,e.displayViewMat3,t)}},{key:"getTextures",value:function(){if(!this._rasterTexture)return null;var e=[],t=[];return this._transformGridTexture&&(t.push(this._transformGridTexture),e.push("u_transformGrid")),this._rasterTexture&&(t.push(this._rasterTexture),e.push("u_image")),this._colormapTexture&&(t.push(this._colormapTexture),e.push("u_colormap")),{names:e,textures:t}}},{key:"getMemoryUsage",value:function(){if(Object(m.h)(this._memoryUsed)){var e=this.getTextures();if(null==e)return 0;this._memoryUsed=e.textures.map((function(e){return e.descriptor.width*e.descriptor.height*4})).reduce((function(e,t){return e+t}))}return this._memoryUsed}},{key:"onAttach",value:function(){this.invalidateTexture()}},{key:"onDetach",value:function(){this.invalidateTexture()}},{key:"updateTexture",value:function(e){var t,r,i,a=e.context;if(!this.stage)return null==(t=this._rasterTexture)||t.dispose(),null==(r=this._transformGridTexture)||r.dispose(),null==(i=this._colormapTexture)||i.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,void(this._colormapTexture=null);if(this._textureInvalidated){this._textureInvalidated=!1;var s=this.source,n=s&&s.pixels&&s.pixels.length>0;this._createOrDestroyRasterTexture(a),this._rasterTexture&&(n?(this._updateColormapTexture(a),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Object(V.c)(a,this.transformGrid))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender())}}},{key:"_createOrDestroyRasterTexture",value:function(e){var t,r,i=this.source?Object(j.h)(this.source,this.bandIds):null;if(i&&i.pixels&&i.pixels.length>0){var a=null==this._rasterTextureBandIds&&null==this.bandIds||this._rasterTextureBandIds&&this.bandIds&&this._rasterTextureBandIds.join("")===this.bandIds.join("");if(this._rasterTexture){if(a)return;this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null}var s=this.interpolation||"nearest",n=this.isRendereredSource||!(null!=(t=e.capabilities.textureFloat)&&t.textureFloat);this._rasterTexture=Object(V.b)(e,i,s,n),this._supportsBilinear=null==(r=e.capabilities.textureFloat)?void 0:r.textureFloatLinear,this._rasterTextureBandIds=this.bandIds?Object(w.a)(this.bandIds):null}else this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null)}},{key:"_updateColormapTexture",value:function(e){var t=this._colormap,r=this.symbolizerParameters.colormap;return r?t?r.length!==t.length||r.some((function(e,r){return e!==t[r]}))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=Object(V.a)(e,r),void(this._colormap=r)):void 0:(this._colormapTexture=Object(V.a)(e,r),void(this._colormap=r)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}}]),r}(B.a);function L(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Object(u.a)(e);if(t){var a=Object(u.a)(this).constructor;r=Reflect.construct(i,arguments,a)}else r=i.apply(this,arguments);return Object(o.a)(this,r)}}var E=function(e){Object(l.a)(r,e);var t=L(r);function r(e,i,a){var n,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return Object(s.a)(this,r),(n=t.call(this,e,i,a)).bitmap=new D(l,null,null),n.bitmap.coordScale=a,n.bitmap.once("isReady",(function(){return n.ready()})),n}return Object(n.a)(r,[{key:"destroy",value:function(){Object(I.a)(Object(u.a)(r.prototype),"destroy",this).call(this),this.bitmap.destroy(),this.bitmap=null,this.stage=null}},{key:"stencilRef",get:function(){return this.bitmap.stencilRef},set:function(e){this.bitmap.stencilRef=e}},{key:"getMemoryUsage",value:function(){return this.bitmap.getMemoryUsage()}},{key:"setTransform",value:function(e,t){Object(I.a)(Object(u.a)(r.prototype),"setTransform",this).call(this,e,t),this.bitmap.transforms.dvs=this.transforms.dvs}},{key:"onAttach",value:function(){this.bitmap.stage=this.stage}},{key:"onDetach",value:function(){this.bitmap.stage=null}}]),r}(r("QPvm").a),q=r("FNqF");function M(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Object(u.a)(e);if(t){var a=Object(u.a)(this).constructor;r=Reflect.construct(i,arguments,a)}else r=i.apply(this,arguments);return Object(o.a)(this,r)}}var A=function(e){Object(l.a)(r,e);var t=M(r);function r(){var e;return Object(s.a)(this,r),(e=t.apply(this,arguments)).isCustomTilingScheme=!1,e}return Object(n.a)(r,[{key:"createTile",value:function(e){var t=this._getTileBounds(e);return new E(e,t,this._tileInfoView.tileInfo.size)}},{key:"destroyTile",value:function(){}},{key:"prepareRenderPasses",value:function(e){var t=this,i=e.registerRenderPass({name:"bitmap (tile)",brushes:[S.a.raster],target:function(){return t.children.map((function(e){return e.bitmap}))},drawPhase:q.c.MAP});return[].concat(Object(w.a)(Object(I.a)(Object(u.a)(r.prototype),"prepareRenderPasses",this).call(this,e)),[i])}},{key:"doRender",value:function(e){this.visible&&e.drawPhase===q.c.MAP&&Object(I.a)(Object(u.a)(r.prototype),"doRender",this).call(this,e)}},{key:"_getTileBounds",value:function(e){var t=this._tileInfoView.getTileBounds(Object(R.g)(),e);if(this.isCustomTilingScheme&&e.world){var r=this._tileInfoView.tileInfo,i=Object(P.o)(r.spatialReference);if(i){var a=r.lodAt(e.level).resolution,s=i/a%r.size[0],n=s?(r.size[0]-s)*a:0;t[0]-=n*e.world,t[2]-=n*e.world}}return t}}]),r}(r("ezmY").a),Q=r("55C+"),N=r("xTsm"),W=r("0s/2"),J=r("ajvB"),H=r("Mp7X"),Y=r("eTpk");function Z(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Object(u.a)(e);if(t){var a=Object(u.a)(this).constructor;r=Reflect.construct(i,arguments,a)}else r=i.apply(this,arguments);return Object(o.a)(this,r)}}var X=function(e){var t=function(e){Object(l.a)(i,e);var t,r=Z(i);function i(){var e;return Object(s.a)(this,i),(e=r.apply(this,arguments))._rasterFieldPrefix="Raster.",e.layer=null,e.view=null,e.fullExtent=null,e.tileInfo=null,e.datumTransformation=null,e}return Object(n.a)(i,[{key:"hasTilingEffects",get:function(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}},{key:"fetchPopupFeatures",value:(t=Object(a.a)(h.a.mark((function e(t,r){var i,a,s,n,l,o,u,c,f,d,b,y,_,v,g,x,T;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.layer,t){e.next=3;break}return e.abrupt("return",Promise.reject(new H.a("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i})));case 3:if(a=i.popupEnabled,s=Object(Y.a)(i,r),a&&Object(m.i)(s)){e.next=6;break}throw new H.a("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:a,popupTemplate:s});case 6:return n=[],e.next=9,i.identify(t);case 9:if(l=e.sent,o=l.value,u="",o&&o.length){if(u="imagery-tile"===i.type&&i.hasStandardTime()&&null!=o[0]?o.map((function(e){return i.getStandardTimeValue(e)})).join(", "):o.join(", "),(d={ObjectId:0})[b="Raster.ServicePixelValue"]=this._formatAttributeValue(u,b),(y=null==(c=i.rasterInfo)||null==(f=c.attributeTable)?void 0:f.features)&&y.length>0&&(_=y.filter((function(e){var t=e.attributes.value||e.attributes.Value||e.attributes.VALUE;return String(t)===u}))).length>0&&(v=_[0]))for(g in v.attributes)v.attributes.hasOwnProperty(g)&&(x=this._rasterFieldPrefix+g,d[x]=this._formatAttributeValue(v.attributes[g],x));(T=new p.a(this.fullExtent.clone(),null,d)).layer=i,T.sourceLayer=T.layer,n.push(T)}return e.abrupt("return",n);case 14:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"updateFullExtent",value:function(){var e,t=this.layer.tileInfo;t&&t.spatialReference||(e=new H.a("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));var r=Object(k.b)(this.layer.fullExtent,this.view.spatialReference,!1),i=Object(k.g)(this.layer.fullExtent,this.view.spatialReference,r);return null==i&&(e=new H.a("layerview:projection-not-supported","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})),this._set("fullExtent",i),this.datumTransformation||(this.datumTransformation=Object(k.b)(this.layer.fullExtent,this.view.spatialReference,!0)),e?Promise.reject(e):Promise.resolve()}},{key:"_formatAttributeValue",value:function(e,t){if("string"==typeof e){var r,i,a=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,s=this._getFieldInfo(a,t),n=s&&s.format;if(n)return e.trim().indexOf(",")>-1?(i=(r=",")+" ",this._formatDelimitedString(e,r,i,n)):e.trim().indexOf(" ")>-1?(r=i=" ",this._formatDelimitedString(e,r,i,n)):this._formatNumberFromString(e,n)}return e}},{key:"_getFieldInfo",value:function(e,t){if(e&&e.length&&t){var r,i=t.toLowerCase();return e.some((function(e){return!(!e.fieldName||e.fieldName.toLowerCase()!==i&&e.fieldName.toLowerCase()!==i.replace(/ /g,"_")||(r=e,0))})),r}}},{key:"_formatDelimitedString",value:function(e,t,r,i){var a=this;return e&&t&&r&&i?e.trim().split(t).map((function(e){return a._formatNumberFromString(e,i)})).join(r):e}},{key:"_formatNumberFromString",value:function(e,t){if(!e||!t)return e;var r=Number(e);return isNaN(r)?e:t.format(r)}}]),i}(e);return Object(f.a)([Object(v.b)()],t.prototype,"layer",void 0),Object(f.a)([Object(v.b)()],t.prototype,"view",void 0),Object(f.a)([Object(v.b)()],t.prototype,"fullExtent",void 0),Object(f.a)([Object(v.b)()],t.prototype,"tileInfo",void 0),Object(f.a)([Object(v.b)({readOnly:!0})],t.prototype,"hasTilingEffects",null),t=Object(f.a)([Object(g.a)("esri.views.layers.ImageryTileLayerView")],t)},K=r("bPf0"),$=r("TRFF"),ee=r("VLTM"),te=r("9PpZ"),re=r("nd5+"),ie=r("OTJA");function ae(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=Object(u.a)(e);if(t){var a=Object(u.a)(this).constructor;r=Reflect.construct(i,arguments,a)}else r=i.apply(this,arguments);return Object(o.a)(this,r)}}var se=d.a.getLogger("esri.views.2d.layers.ImageryTileLayerView2D"),ne=[0,0],le=function(e){Object(l.a)(f,e);var t,r,o,u,c=ae(f);function f(){var e;return Object(s.a)(this,f),(e=c.apply(this,arguments))._tileStrategy=null,e._tileInfoView=null,e._fetchQueue=null,e._blockCacheRegistryUrl=null,e._blockCacheRegistryId=null,e._bitmapView=null,e._emptyTilePixelBlock=null,e._srcResolutions=null,e._previousLOD=null,e._needBlockCacheUpdate=!1,e._globalSymbolizerParams=null,e._symbolizerParams=null,e._abortController=null,e._globalUpdateRequested=!1,e._isCustomTilingScheme=!1,e.useWebGLForProcessing=!0,e._redrawOrRefreshDebounced=Object(b.i)((function(t,r){return t?(e._set("refreshTimestamp",Date.now()),e.doRefresh()):e._redrawImage(r)})),e}return Object(n.a)(f,[{key:"initialize",value:function(){var e=this.updateFullExtent();this.addResolvingPromise(e)}},{key:"useProgressiveUpdate",get:function(){return null==this._get("useProgressiveUpdate")||this._get("useProgressiveUpdate")},set:function(e){var t=this;if(this._tileStrategy&&this.useProgressiveUpdate!==e){this._tileStrategy.destroy(),this._bitmapView.removeAllChildren();var r=this._getCacheSize(e);this._tileStrategy=new J.a({cachePolicy:"purge",acquireTile:function(e){return t.acquireTile(e)},releaseTile:function(e){return t.releaseTile(e)},cacheSize:r,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",e),this.requestUpdate()}}},{key:"hitTest",value:function(e,t){if(this.suspended)return Promise.resolve(null);var r=this.view.toMap(Object(y.a)(e,t));return Promise.resolve(new p.a({attributes:{},geometry:r}))}},{key:"update",value:function(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume();var t=e.state,r=t.extent,i=t.resolution,a=t.scale,s=this._tileInfoView.getClosestInfoForScale(a);if(this.layer.raster){var n;if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){var l=this._srcResolutions[s.level],o=r.toJSON?r:re.a.fromJSON(r);Object(O.h)(this._blockCacheRegistryUrl,this._blockCacheRegistryId,o,i,l,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,(null==(n=this._previousLOD)?void 0:n.level)!==s.level&&(this._previousLOD=s,null!=this._symbolizerParams&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}this.notifyChange("updating")}},{key:"attach",value:function(){var e=this;this.layer.increaseRasterJobHandlerUsage(),Object(te.a)().supportsTextureFloat||(this.useWebGLForProcessing=!1),this.layer.raster&&(this.layer.raster.ioConfig.allowPartialFill=!0),this._initializeTileInfo(),this._tileInfoView=new N.a(this.tileInfo,this.fullExtent);var t=this._computeFetchConcurrency();this._fetchQueue=new W.a({tileInfoView:this._tileInfoView,concurrency:t,process:function(t,r){return e.fetchTile(t,r)}});var r=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new J.a({cachePolicy:"purge",acquireTile:function(t){return e.acquireTile(t)},releaseTile:function(t){return e.releaseTile(t)},cacheSize:r,tileInfoView:this._tileInfoView}),this._bitmapView=new A(this._tileInfoView),this._bitmapView.isCustomTilingScheme=this._isCustomTilingScheme,this.container.addChild(this._bitmapView),this.handles.add([Object(_.d)(this.layer,["bandIds","renderer","interpolation","multidimensionalDefinition"],(function(t,r,i){var a="multidimensionalDefinition"===i,s="interpolation"===i&&("majority"===t||"majority"===r)&&e._canUseMajorityInterpolationOnDataSource(),n=a||s;e._redrawOrRefreshDebounced(n).catch((function(e){Object(b.m)(e)||se.error(e)}))}))],"attach"),this._updateBlockCacheRegistry()}},{key:"detach",value:function(){this.handles.remove("attach"),this.layer.decreaseRasterJobHandlerUsage(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,Object(O.g)(this._blockCacheRegistryUrl,this._blockCacheRegistryId)}},{key:"moveStart",value:function(){this.requestUpdate()}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"moveEnd",value:function(){var e=this;!this.hasTilingEffects&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=Object(b.d)(),0===this._fetchQueue.length&&this._redrawImage(this._abortController.signal).then((function(){e._globalUpdateRequested=!1,e.requestUpdate()})));var t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(t),this.requestUpdate()}},{key:"createFetchPopupFeaturesQueryGeometry",value:function(e,t){return Object(ee.a)(e,t,this.view)}},{key:"doRefresh",value:(u=Object(a.a)(h.a.mark((function e(){var t,r=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.suspended){e.next=2;break}return e.abrupt("return");case 2:return this.layer.updateRenderer(),this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset(),t=[],this._tileStrategy.tiles.forEach((function(e){return t.push(r._enqueueTileFetch(e))})),e.next=7,Object(b.j)(t);case 7:this.notifyChange("updating");case 8:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"isUpdating",value:function(){return this._fetchQueue.length>0||this._globalUpdateRequested}},{key:"acquireTile",value:function(e){var t,r,a,s,n=this._bitmapView.createTile(e),l=n.bitmap;return t=this._tileInfoView.getTileCoords(ne,n.key),r=Object(i.a)(t,2),l.x=r[0],l.y=r[1],l.resolution=this._tileInfoView.getTileResolution(n.key),a=this._tileInfoView.tileInfo.size,s=Object(i.a)(a,2),l.width=s[0],l.height=s[1],this._enqueueTileFetch(n),this.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.hasTilingEffects||!this.useProgressiveUpdate,n}},{key:"releaseTile",value:function(e){var t=this;this._fetchQueue.abort(e.key.id),this._bitmapView.removeChild(e),e.once("detach",(function(){e.destroy(),t.requestUpdate()})),this.requestUpdate()}},{key:"fetchTile",value:function(e,t){var r=!Object(m.h)(t)&&t.signal,i=this._canUseWebGLForProcessing(),a={tileInfo:this.tileInfo,signal:Object(m.p)(r),registryId:this._blockCacheRegistryId,requestRawData:i,srcResolution:this._srcResolutions[e.level],datumTransformation:this.datumTransformation,interpolation:i?"nearest":this.layer.interpolation};return this.layer.fetchTile(e.level,e.row,e.col,a)}},{key:"_canUseWebGLForProcessing",value:function(){return this.useWebGLForProcessing&&this.layer.symbolizer.canRenderInWebGL&&!("majority"===this.layer.interpolation&&this._canUseMajorityInterpolationOnDataSource())}},{key:"_getCacheSize",value:function(e){return e?40:0}},{key:"_initializeTileInfo",value:function(){var e=this.view.spatialReference,t=new ie.a({x:this.fullExtent.xmin,y:this.fullExtent.ymax,spatialReference:e}),r=Object(k.a)(this.layer.rasterInfo,e),i=r.scales,a=r.srcResolutions,s=r.isCustomTilingScheme,n=T.a.create({spatialReference:e,size:512,scales:i});(0===n.origin.x||n.origin.x>t.x)&&(n.origin=t),this._isCustomTilingScheme=s,this._set("tileInfo",n),this._srcResolutions=null!=a?a:[]}},{key:"_computeFetchConcurrency",value:function(){var e=this.layer.rasterInfo.storageInfo.blockBoundary,t=e[e.length-1];return(t.maxCol-t.minCol+1)*(t.maxRow-t.minRow+1)>64?2:10}},{key:"_enqueueTileFetch",value:(o=Object(a.a)(h.a.mark((function e(t,r){var i,a,s,n,l,o,u,c=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._fetchQueue.has(t.key.id)){e.next=41;break}return e.prev=1,e.next=4,this._fetchQueue.push(t.key);case 4:if(i=e.sent,a=this.layer.bandIds,s=!this.useProgressiveUpdate||this.hasTilingEffects&&!this._globalSymbolizerParams,!this._globalUpdateRequested||this.moving||0!==this._fetchQueue.length){e.next=18;break}return s=!1,e.prev=9,e.next=12,this._redrawImage(this._abortController&&this._abortController.signal);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(9),Object(b.m)(e.t0)&&se.error(e.t0);case 17:this._globalUpdateRequested=!1;case 18:if((n=this._canUseWebGLForProcessing())&&!this.hasTilingEffects&&null==this._symbolizerParams&&this._updateSymbolizerParams(),!i||!i.pixelBlock){e.next=32;break}if(l={extent:i.extent,pixelBlock:i.pixelBlock},t.bitmap.rawPixelData=l,!n){e.next=25;break}t.bitmap.source=i.pixelBlock,t.bitmap.isRendereredSource=!1,e.next=29;break;case 25:return e.next=27,this.layer.applyRenderer(l,this.hasTilingEffects&&this._globalSymbolizerParams&&"stretch"===this._globalSymbolizerParams.type?this._globalSymbolizerParams:null);case 27:o=e.sent,t.bitmap.source=o,t.bitmap.isRendereredSource=!0;case 29:t.bitmap.symbolizerParameters=n?this._globalSymbolizerParams||this._symbolizerParams:null,n?t.bitmap.transformGrid||(t.bitmap.transformGrid=i.transformGrid):t.bitmap.transformGrid=null,e.next=34;break;case 32:u=this._createEmptyTilePixelBlock(),t.bitmap.source=u,t.bitmap.symbolizerParameters=n?this._symbolizerParams:null,t.bitmap.transformGrid=null;case 34:t.bitmap.bandIds=a,t.bitmap.width=this._tileInfoView.tileInfo.size[0],t.bitmap.height=this._tileInfoView.tileInfo.size[1],t.bitmap.interpolation=this._getLayerInterpolation(),t.bitmap.suspended=s,t.bitmap.invalidateTexture(),t.once("attach",(function(){return c.requestUpdate()})),this._bitmapView.addChild(t),e.next=40;break;case 37:e.prev=37,e.t1=e.catch(1),Object(b.m)(e.t1)||se.error(e.t1);case 40:this.requestUpdate();case 41:case"end":return e.stop()}}),e,this,[[1,37],[9,14]])}))),function(e,t){return o.apply(this,arguments)})},{key:"_redrawImage",value:(r=Object(a.a)(h.a.mark((function e(t){var r,i,s=this;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.layer.updateRenderer(),!this.hasTilingEffects){e.next=6;break}return e.next=4,this._updateGlobalSymbolizerParams(t);case 4:e.next=7;break;case 6:this._updateSymbolizerParams(),this._globalSymbolizerParams=null;case 7:return r=this.layer.bandIds,i=this._bitmapView.children.map(function(){var e=Object(a.a)(h.a.mark((function e(t){var i;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((i=s._canUseWebGLForProcessing())||!t.bitmap.rawPixelData){e.next=8;break}return e.next=4,s.layer.applyRenderer(t.bitmap.rawPixelData,s.hasTilingEffects&&s._globalSymbolizerParams&&"stretch"===s._globalSymbolizerParams.type?s._globalSymbolizerParams:null);case 4:t.bitmap.source=e.sent,t.bitmap.isRendereredSource=!0,e.next=9;break;case 8:t.bitmap.isRendereredSource&&t.bitmap.rawPixelData&&(t.bitmap.source=t.bitmap.rawPixelData.pixelBlock),t.bitmap.isRendereredSource=!1;case 9:t.bitmap.symbolizerParameters=i?s._globalSymbolizerParams||s._symbolizerParams:null,t.bitmap.bandIds=r,t.bitmap.interpolation=s._getLayerInterpolation(),t.bitmap.suspended=!1;case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=10,Object(b.j)(i);case 10:this.container.requestRender();case 11:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"_createEmptyTilePixelBlock",value:function(){if(!this._emptyTilePixelBlock){var e=this._tileInfoView.tileInfo.size[0],t=this._tileInfoView.tileInfo.size[1];this._emptyTilePixelBlock=new x.a({width:e,height:t,pixels:[new Uint8Array(e*t)],mask:new Uint8Array(e*t),pixelType:"u8"})}return this._emptyTilePixelBlock}},{key:"_updateGlobalSymbolizerParams",value:(t=Object(a.a)(h.a.mark((function e(t){var r,i,a;return h.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={srcResolution:this._srcResolutions[this._previousLOD.level],registryId:this._blockCacheRegistryId,signal:t},e.next=3,this.layer.fetchPixels(this.view.extent,this.view.width,this.view.height,r);case 3:if((i=e.sent)&&i.pixelBlock){e.next=6;break}return e.abrupt("return");case 6:a=this.layer.symbolizer.generateWebGLParameters({pixelBlock:Object(j.h)(i.pixelBlock,this.layer.bandIds),isGCS:this.view.spatialReference.isGeographic,resolution:{x:this._previousLOD.resolution,y:this._previousLOD.resolution},bandIds:this.layer.bandIds}),!this._canUseWebGLForProcessing()&&a&&"stretch"===a.type&&this.layer.renderer&&"raster-stretch"===this.layer.renderer.type&&(a.factor=a.factor.map((function(e){return 255*e})),a.outMin=Math.round(255*a.outMin),a.outMax=Math.round(255*a.outMax)),this._globalSymbolizerParams=a;case 8:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"_updateSymbolizerParams",value:function(){this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.view.spatialReference.isGeographic,resolution:{x:this._previousLOD.resolution,y:this._previousLOD.resolution},bandIds:this.layer.bandIds})}},{key:"_updateBlockCacheRegistry",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.layer,r=t.url,i=t.rasterInfo,a=t.multidimensionalDefinition,s=t.raster,n=null!=i&&i.multidimensionalInfo?s.getSliceIndex(a):null,l=Object(O.d)(r,n);if(l!==this._blockCacheRegistryUrl){if(null!=this._blockCacheRegistryUrl&&Object(O.g)(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=Object(O.f)(l,this.layer.raster.rasterInfo),e){var o=this._tileInfoView.getClosestInfoForScale(this.view.scale),u=this._srcResolutions[o.level];Object(O.h)(l,this._blockCacheRegistryId,this.view.extent,this.view.resolution,u,this.layer.raster.ioConfig.sampling)}this._blockCacheRegistryUrl=l}}},{key:"_canUseMajorityInterpolationOnDataSource",value:function(){var e=this.layer.rasterInfo,t=e.bandCount,r=e.attributeTable,i=e.colormap,a=e.pixelType;return 1===t&&(null!=r||null!=i||"u8"===a||"s8"===a)}},{key:"_getLayerInterpolation",value:function(){var e=this.layer.renderer.type;if("raster-colormap"===e||"unique-value"===e||"class-breaks"===e)return"nearest";var t=this.layer.renderer;return"raster-stretch"===t.type&&null!=t.colorRamp?"nearest":this.layer.interpolation}}]),f}(X(Object($.a)(Object(Q.a)(K.a))));Object(f.a)([Object(v.b)()],le.prototype,"useProgressiveUpdate",null);var oe=le=Object(f.a)([Object(g.a)("esri.views.2d.layers.ImageryTileLayerView2D")],le);t.default=oe}}]);
//# sourceMappingURL=22-163432dc1a2bc9a62c52.js.map